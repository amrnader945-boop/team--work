<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AMR LAB ‚Äî Patient Report</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="report">
  <div class="card header">
    <h1>üß™ AMR LAB</h1>
    <p>Patient Laboratory Report</p>
  </div>

  <div class="card patient-info">
    <div><strong>ID:</strong> <span id="p-id">--</span></div>
    <div><strong>Name:</strong> <span id="p-name">--</span></div>
    <div><strong>Age:</strong> <span id="p-age">--</span></div>
    <div><strong>Gender:</strong> <span id="p-gender">--</span></div>
    <div><strong>Phone:</strong> <span id="p-phone">--</span></div>
    <div><strong>Email:</strong> <span id="p-email">--</span></div>
  </div>

  <div class="card results">
    <h3>Test Results</h3>
    <table>
      <tr><th>Test</th><th>Value</th></tr>
      <tr><td>ABS</td><td id="r-abs">--</td></tr>
      <tr><td>CONC</td><td id="r-conc">--</td></tr>
      <tr><td>TRANS</td><td id="r-trans">--</td></tr>
    </table>
  </div>

  <div class="actions">
    <a id="whatsappBtn" class="btn whatsapp" target="_blank">üì© Send via WhatsApp</a>
    <button id="simulateButton" class="btn">‚öôÔ∏è Simulate Update</button>

    <div style="margin-top:12px;">
      <button id="onBtn" class="btn">ON</button>
      <button id="offBtn" class="btn">OFF</button>
      <button id="backBtn" class="btn ghost">‚¨Ö Back</button>
    </div>

    <div class="status-line">
      Serial: <span id="connStatus">unknown</span>
    </div>
  </div>
</div>

<!-- floating connect button + shared script -->
<div id="serial-floating"></div>
<script src="script.js"></script>
<script>
initSerialFloating(); // show floating button and set handlers

// load patient data
const params = new URLSearchParams(location.search);
let id = params.get('id');

function showData(pid, patient) {
  document.getElementById('p-id').innerText = pid;
  document.getElementById('p-name').innerText = patient.name || '--';
  document.getElementById('p-age').innerText = patient.age || '--';
  document.getElementById('p-gender').innerText = patient.gender || '--';
  document.getElementById('p-phone').innerText = patient.phone || '--';
  document.getElementById('p-email').innerText = patient.email || '--';
  const r = patient.results || {};
  document.getElementById('r-abs').innerText = r.ABS ?? '--';
  document.getElementById('r-conc').innerText = r.CONC ?? '--';
  document.getElementById('r-trans').innerText = r.TRANS ?? '--';
  // whatsapp link
  const link = `${location.origin}${location.pathname}?id=${pid}`;
  document.getElementById('whatsappBtn').href = `https://wa.me/${(patient.phone||'').replace('+','')}?text=${encodeURIComponent('Your results are ready:\\n'+link)}`;
}

// try server first (if hosted), else localStorage
if (location.hostname.includes('github.io')) {
  const saved = localStorage.getItem('patientData');
  if (!saved) { alert('No patient data. Please login.'); window.location.href='index.html'; }
  const p = JSON.parse(saved); id = id || p.id; showData(id, p);
} else {
  fetch(`/patients/${id}`).then(r=>r.json()).then(j=>{
    if (j.success) showData(id, j.patient);
    else {
      const saved = JSON.parse(localStorage.getItem('patientData')||'{}');
      if (!saved.id) { alert('No patient data.'); window.location.href='index.html'; }
      showData(saved.id, saved);
    }
  }).catch(()=> {
    const saved = JSON.parse(localStorage.getItem('patientData')||'{}');
    if (!saved.id) { alert('No patient data.'); window.location.href='index.html'; }
    showData(saved.id, saved);
  });
}

// buttons
document.getElementById('backBtn').addEventListener('click', ()=>window.history.back());

document.getElementById('simulateButton').addEventListener('click', ()=> {
  const newResults = {
    ABS: Math.floor(10 + Math.random()*20),
    CONC: Math.floor(120 + Math.random()*80),
    TRANS: Math.floor(10 + Math.random()*10)
  };
  // update localStorage and UI
  const saved = JSON.parse(localStorage.getItem('patientData')||'{}');
  saved.results = newResults;
  localStorage.setItem('patientData', JSON.stringify(saved));
  showData(saved.id || id, saved);
  alert('Simulated update applied locally.');
});

// ON / OFF send via serial (if connected)
document.getElementById('onBtn').addEventListener('click', async ()=> {
  try {
    await serialWrite('1');
    alert('Sent ON (1) to Arduino');
  } catch(e) { alert('Send failed: '+e.message); }
});
document.getElementById('offBtn').addEventListener('click', async ()=> {
  try {
    await serialWrite('0');
    alert('Sent OFF (0) to Arduino');
  } catch(e) { alert('Send failed: '+e.message); }
});

// update connection status badge periodically
setInterval(()=> {
  const st = serialIsOpen() ? `connected (${serialInfo().path || 'open'})` : 'not connected';
  const el = document.getElementById('connStatus');
  if (el) el.innerText = st;
}, 900);
</script>
</body>
</html>
