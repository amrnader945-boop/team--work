<!-- public/patient.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AMR LAB â€” Patient Results</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="result-wrap">
    <div class="result-card">
      <h2 id="lab-title">AMR LAB - Patient Report</h2>
      <div class="info">
        <div><strong>ID:</strong> <span id="p-id"></span></div>
        <div><strong>Name:</strong> <span id="p-name"></span></div>
        <div><strong>Age:</strong> <span id="p-age"></span></div>
        <div><strong>Gender:</strong> <span id="p-gender"></span></div>
        <div><strong>Doctor:</strong> <span id="p-doctor"></span></div>
        <div><strong>Phone:</strong> <span id="p-phone"></span></div>
        <div><strong>Email:</strong> <span id="p-email"></span></div>
      </div>

      <h3>Test Results</h3>
      <table id="results-table">
        <tr><td>ABS</td><td id="r-abs">--</td></tr>
        <tr><td>CONC</td><td id="r-conc">--</td></tr>
        <tr><td>TRANS</td><td id="r-trans">--</td></tr>
      </table>

      <div class="actions">
        <a id="whatsappBtn" class="btn whatsapp" target="_blank">Send Link via WhatsApp</a>
        <button id="simulateButton" class="btn">Simulate Arduino Update</button>
      </div>
    </div>
  </div>

<script>
  // when page loads, try to get id from query or localStorage
  const params = new URLSearchParams(location.search);
  const id = params.get('id');

  function showData(patientId, patient) {
    document.getElementById('p-id').innerText = patientId;
    document.getElementById('p-name').innerText = patient.name;
    document.getElementById('p-age').innerText = patient.age;
    document.getElementById('p-gender').innerText = patient.gender;
    document.getElementById('p-doctor').innerText = patient.doctor;
    document.getElementById('p-phone').innerText = patient.phone;
    document.getElementById('p-email').innerText = patient.email;
    const r = patient.results || {};
    document.getElementById('r-abs').innerText = r.ABS ?? '--';
    document.getElementById('r-conc').innerText = r.CONC ?? '--';
    document.getElementById('r-trans').innerText = r.TRANS ?? '--';

    // whatsapp button
    const link = `${location.origin}/patient.html?id=${patientId}`;
    document.getElementById('whatsappBtn').href = `https://wa.me/${patient.phone.replace('+','')}?text=${encodeURIComponent('Your results: '+link)}`;
  }

  if (id) {
    fetch(`/patients/${id}`)
      .then(r=>r.json()).then(json=>{
        if (json.success) showData(id, json.patient);
        else alert('Patient not found');
      }).catch(e=>{ console.error(e); alert('Error loading'); });
  } else {
    // try from localStorage (login flow)
    const raw = localStorage.getItem('patientData');
    if (raw) {
      const patient = JSON.parse(raw);
      showData(patient.id || 'local', patient);
    } else {
      alert('No patient selected. Go to login page.');
      window.location.href = '/';
    }
  }

  // simulate Arduino: open a small POST to /arduino-update to update results
  document.getElementById('simulateButton').addEventListener('click', () => {
    const patientId = id || (JSON.parse(localStorage.getItem('patientData')||'{}').id);
    if (!patientId) return alert('No patient ID');

    const newResults = {
      ABS: Math.floor(10 + Math.random()*10),
      CONC: Math.floor(120 + Math.random()*80),
      TRANS: Math.floor(15 + Math.random()*12)
    };

    fetch('/arduino-update', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: patientId, results: newResults })
    })
    .then(r=>r.json())
    .then(j=>{
      if (j.success) {
        alert('Arduino update sent. WhatsApp (if configured) will be sent');
        // refresh
        location.reload();
      } else alert('Update failed');
    }).catch(e=>{ console.error(e); alert('Error'); });
  });
</script>
</body>
</html>
